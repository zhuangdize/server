node {
  try {
    stage('检出代码'){
      git branch: "${BRANCH}",credentialsId: "${credentialsId}", url: "${REPO_URL}"
    }

    stage('构建代码') {
      echo "当前运行环境为：${BUILD_ENV}"
      sh 'node -v'
      sh 'npm -v'
      sh 'npm config set registry https://registry.npm.taobao.org npm info underscore'
      sh 'npm install'
    }

    stage('发包') {
      sh "rsync -r -avz --delete --exclude=.git ./ /var/www/${JOB_NAME}"
      sh 'npm run servers'
    }

    stage('通知负责人') {
      emailext body: "项目构建成功", subject: '构建项目${JOB_NAME}【成功】', to: "${EMAIL}"
    }
  } catch(e) {
    def ERROR_REASON = "${e.toString()}"
    emailext body: "<!DOCTYPE html><html>\n<head>\n<meta charset='UTF-8'>\n<title>${ENV, var="JOB_NAME"}-第${BUILD_NUMBER}次构建日志</title>\n</head>\n<body>\n<ul>\n<li>失败原因： ${ERROR_REASON}</li>\n</ul>\n</body>\n</html>", subject: '【构建通知】${JOB_NAME}- Build # ${BUILD_NUMBER} - 构建失败!', to: "${EMAIL}"
    // echo "${e.toString()}"
  }
}