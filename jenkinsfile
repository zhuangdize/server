node {
  try {
    stage('检出代码'){
      git branch: "${BRANCH}",credentialsId: "${credentialsId}", url: "${REPO_URL}"
    }

    stage('构建代码') {
      echo "当前运行环境为：${BUILD_ENV}"
      sh 'node -v'
      sh 'npm -v'
      sh 'npm config set registry https://registry.npm.taobao.org npm info underscore'
      sh 'npm install'
    }

    stage('发包') {
      sh "rsync -r -avz --delete --exclude=.git ./ /var/www/${JOB_NAME}"
      sh 'npm run servers'
    }

    stage('通知负责人') {
      emailext body: "项目构建成功", subject: '构建项目${JOB_NAME}【成功】', to: "${EMAIL}"
    }
  } catch(e) {
    def ERROR_REASON = "${e.toString()}"
    echo "${ERROR_REASON}"
    emailext body: '<!DOCTYPE html><html>\n
    <head>\n
    <meta charset="UTF-8">\n    
    <title>${ENV, var="JOB_NAME"}-第${BUILD_NUMBER}次构建日志</title>\n
    </head>\n
    <body leftmargin="8" marginwidth="0" topmargin="8" marginheight="4" offset="0">\n
        <table width="95%" cellpadding="0" cellspacing="0"  style="font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif">\n
            <tr>\n
                本邮件由系统自动发出，无需回复！<br/>\n
        </br>\n
                <td><font color="#CC0000">构建结果</font></td>\n
            </tr>\n
            <tr>\n
                <td><br />\n
                <b><font color="#0B610B">构建信息</font></b>\n
                <hr size="2" width="100%" align="center" /></td>\n
            </tr>\n
            <tr>\n
                <td>\n
                    <ul>\n
                        <li>项目名称 ： server</li>\n
                        <li>构建编号 ： 第${BUILD_NUMBER}次构建</li>\n
                        <li>失败原因： ${ERROR_REASON}</li>\n
                        <li>构建日志： <a href="${BUILD_URL}console">${BUILD_URL}console</a></li>\n
                        <li>工作目录 ： <a href="${JENKINS_URL}">${JENKINS_URL}</a></li>\n
                        <li>项目  Url ： <a href="http://118.25.250.43:3000/">http://118.25.250.43:3000/</a></li>\n
                    </ul>\n
    <hr size="2" width="100%" />\n
    <ul>\n
    </ul>\n
   <br/>\n
    
                </td>\n    
            </tr>\n
        </table>\n 
    </body>\n
    </html>', subject: '【构建通知】${JOB_NAME}- Build # ${BUILD_NUMBER} - 构建失败!', to: "${EMAIL}"
    // echo "${e.toString()}"
  }
}